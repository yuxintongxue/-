<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多卷积核CNN可视化</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .explanation {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .demo-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }
        .grid-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            gap: 2px;
            margin: 10px 0;
            border: 2px solid #34495e;
            background-color: #ecf0f1;
            padding: 5px;
            border-radius: 5px;
        }
        .grid-cell {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 3px;
            font-size: 12px;
        }
        .input-channel1 .grid-cell {
            background-color: #ff6b6b;
            color: white;
        }
        .input-channel2 .grid-cell {
            background-color: #51cf66;
            color: white;
        }
        .input-channel3 .grid-cell {
            background-color: #339af0;
            color: white;
        }
        .kernel-channel1 .grid-cell {
            background-color: #ff8787;
            color: white;
        }
        .kernel-channel2 .grid-cell {
            background-color: #69db7c;
            color: white;
        }
        .kernel-channel3 .grid-cell {
            background-color: #4dabf7;
            color: white;
        }
        .feature-map .grid-cell {
            background-color: white;
            color: #333;
            border: 1px solid #ddd;
        }
        .feature-map-0 .grid-cell { background-color: #e3f2fd; }
        .feature-map-1 .grid-cell { background-color: #e8f5e9; }
        .feature-map-2 .grid-cell { background-color: #fff3e0; }
        .feature-map-3 .grid-cell { background-color: #fce4ec; }
        .highlight {
            background-color: #f1c40f !important;
            box-shadow: 0 0 8px rgba(241, 196, 15, 0.8);
        }
        .calculation {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .formula {
            text-align: center;
            font-size: 18px;
            margin: 20px 0;
            padding: 10px;
            background-color: #e8f4fd;
            border-radius: 5px;
        }
        .color-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .color-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        .red { background-color: #ff6b6b; }
        .green { background-color: #51cf66; }
        .blue { background-color: #339af0; }
        .light-red { background-color: #ff8787; }
        .light-green { background-color: #69db7c; }
        .light-blue { background-color: #4dabf7; }
        .feature-0 { background-color: #e3f2fd; }
        .feature-1 { background-color: #e8f5e9; }
        .feature-2 { background-color: #fff3e0; }
        .feature-3 { background-color: #fce4ec; }
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .step-indicator {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
            color: #2c3e50;
        }
        .kernels-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        .kernel-set {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: white;
        }
        .feature-maps-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        .feature-map-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: white;
        }
        .architecture {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .arch-item {
            padding: 10px 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .arrow {
            font-size: 20px;
            color: #7f8c8d;
        }
        .small-text {
            font-size: 12px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>多卷积核CNN可视化</h1>
        
        <div class="explanation">
            <h2>真实CNN中的多卷积核结构</h2>
            <p>在实际的卷积神经网络中，我们使用<strong>多个卷积核</strong>来提取不同的特征：</p>
            
            <div class="architecture">
                <div class="arch-item">
                    <div>输入图像</div>
                    <div class="small-text">[3, 5, 5]</div>
                </div>
                <div class="arrow">→</div>
                <div class="arch-item">
                    <div>4个卷积核</div>
                    <div class="small-text">每个[3, 3, 3]</div>
                </div>
                <div class="arrow">→</div>
                <div class="arch-item">
                    <div>4个特征图</div>
                    <div class="small-text">每个[3, 3]</div>
                </div>
            </div>
            
            <p>每个卷积核独立学习不同的特征：</p>
            <ul>
                <li><strong>卷积核1</strong> - 可能学习边缘检测</li>
                <li><strong>卷积核2</strong> - 可能学习纹理特征</li>
                <li><strong>卷积核3</strong> - 可能学习颜色特征</li>
                <li><strong>卷积核4</strong> - 可能学习形状特征</li>
            </ul>
            
            <div class="formula">
                特征图[k,x,y] = Σ<sub>c=0</sub><sup>2</sup> (输入[c] ⊛ 卷积核[k,c])[x,y] + 偏置[k]
            </div>
            
            <p>其中 k 是卷积核索引，c 是通道索引</p>
        </div>
        
        <div class="color-legend">
            <div class="color-item">
                <div class="color-box red"></div>
                <span>输入通道1</span>
            </div>
            <div class="color-item">
                <div class="color-box green"></div>
                <span>输入通道2</span>
            </div>
            <div class="color-item">
                <div class="color-box blue"></div>
                <span>输入通道3</span>
            </div>
            <div class="color-item">
                <div class="color-box feature-0"></div>
                <span>特征图1</span>
            </div>
            <div class="color-item">
                <div class="color-box feature-1"></div>
                <span>特征图2</span>
            </div>
            <div class="color-item">
                <div class="color-box feature-2"></div>
                <span>特征图3</span>
            </div>
            <div class="color-item">
                <div class="color-box feature-3"></div>
                <span>特征图4</span>
            </div>
        </div>
        
        <div class="step-indicator" id="stepIndicator">准备演示多卷积核卷积过程...</div>
        
        <div class="demo-area">
            <!-- 输入图像 -->
            <div class="grid-container">
                <h3>输入图像 (3×5×5)</h3>
                <div>通道 1</div>
                <div class="grid input-channel1" id="input1" style="grid-template-columns: repeat(5, 1fr);"></div>
                <div>通道 2</div>
                <div class="grid input-channel2" id="input2" style="grid-template-columns: repeat(5, 1fr);"></div>
                <div>通道 3</div>
                <div class="grid input-channel3" id="input3" style="grid-template-columns: repeat(5, 1fr);"></div>
            </div>
            
            <!-- 卷积核 -->
            <div class="grid-container">
                <h3>4个卷积核 (每个3×3×3)</h3>
                <div class="kernels-container" id="kernelsContainer"></div>
            </div>
        </div>
        
        <!-- 特征图 -->
        <div class="grid-container">
            <h3>4个特征图 (每个3×3)</h3>
            <div class="feature-maps-container" id="featureMapsContainer"></div>
        </div>
        
        <div class="calculation" id="calculation">
            点击"开始演示"查看详细计算过程...
        </div>
        
        <div class="explanation">
            <h3>为什么需要多个卷积核？</h3>
            <p>单个卷积核只能提取一种类型的特征。要构建强大的CNN，我们需要多种不同类型的特征检测器：</p>
            
            <div class="kernels-container">
                <div class="kernel-set">
                    <h4>卷积核 1 - 边缘检测</h4>
                    <div>专注于检测图像中的边缘</div>
                    <div class="grid kernel-channel1" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="grid-cell">-1</div><div class="grid-cell">0</div><div class="grid-cell">1</div>
                        <div class="grid-cell">-2</div><div class="grid-cell">0</div><div class="grid-cell">2</div>
                        <div class="grid-cell">-1</div><div class="grid-cell">0</div><div class="grid-cell">1</div>
                    </div>
                </div>
                
                <div class="kernel-set">
                    <h4>卷积核 2 - 纹理检测</h4>
                    <div>专注于检测纹理模式</div>
                    <div class="grid kernel-channel2" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="grid-cell">1</div><div class="grid-cell">1</div><div class="grid-cell">1</div>
                        <div class="grid-cell">0</div><div class="grid-cell">0</div><div class="grid-cell">0</div>
                        <div class="grid-cell">-1</div><div class="grid-cell">-1</div><div class="grid-cell">-1</div>
                    </div>
                </div>
                
                <div class="kernel-set">
                    <h4>卷积核 3 - 角点检测</h4>
                    <div>专注于检测角点和拐角</div>
                    <div class="grid kernel-channel3" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="grid-cell">-1</div><div class="grid-cell">-1</div><div class="grid-cell">-1</div>
                        <div class="grid-cell">-1</div><div class="grid-cell">8</div><div class="grid-cell">-1</div>
                        <div class="grid-cell">-1</div><div class="grid-cell">-1</div><div class="grid-cell">-1</div>
                    </div>
                </div>
                
                <div class="kernel-set">
                    <h4>卷积核 4 - 模糊/平滑</h4>
                    <div>专注于平滑图像</div>
                    <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="grid-cell">0.1</div><div class="grid-cell">0.1</div><div class="grid-cell">0.1</div>
                        <div class="grid-cell">0.1</div><div class="grid-cell">0.2</div><div class="grid-cell">0.1</div>
                        <div class="grid-cell">0.1</div><div class="grid-cell">0.1</div><div class="grid-cell">0.1</div>
                    </div>
                </div>
            </div>
            
            <p>在真实CNN中，卷积核的数量通常在几十到几百个之间，随着网络深度增加而增加。例如，ResNet-50的第一层使用64个卷积核，而深层可能使用512个或更多。</p>
        </div>
        
        <div class="controls">
            <button id="startBtn">开始演示</button>
            <button id="resetBtn">重置</button>
            <button id="nextBtn">下一步</button>
        </div>
    </div>

    <script>
        // 输入数据 (3通道，5x5)
        const inputData = [
            [ // 通道1
                [1, 2, 3, 4, 5],
                [6, 7, 8, 9, 10],
                [11, 12, 13, 14, 15],
                [16, 17, 18, 19, 20],
                [21, 22, 23, 24, 25]
            ],
            [ // 通道2
                [5, 4, 3, 2, 1],
                [10, 9, 8, 7, 6],
                [15, 14, 13, 12, 11],
                [20, 19, 18, 17, 16],
                [25, 24, 23, 22, 21]
            ],
            [ // 通道3
                [2, 4, 6, 8, 10],
                [3, 6, 9, 12, 15],
                [4, 8, 12, 16, 20],
                [5, 10, 15, 20, 25],
                [6, 12, 18, 24, 30]
            ]
        ];
        
        // 4个卷积核，每个3通道，3x3
        const kernelsData = [
            [ // 卷积核1 - 边缘检测
                [
                    [-1, 0, 1],
                    [-2, 0, 2],
                    [-1, 0, 1]
                ],
                [
                    [-1, -2, -1],
                    [0, 0, 0],
                    [1, 2, 1]
                ],
                [
                    [0, -1, 0],
                    [-1, 4, -1],
                    [0, -1, 0]
                ]
            ],
            [ // 卷积核2 - 纹理检测
                [
                    [1, 1, 1],
                    [0, 0, 0],
                    [-1, -1, -1]
                ],
                [
                    [1, 0, -1],
                    [1, 0, -1],
                    [1, 0, -1]
                ],
                [
                    [0, 1, 0],
                    [1, -4, 1],
                    [0, 1, 0]
                ]
            ],
            [ // 卷积核3 - 角点检测
                [
                    [-1, -1, -1],
                    [-1, 8, -1],
                    [-1, -1, -1]
                ],
                [
                    [0, 1, 0],
                    [1, -4, 1],
                    [0, 1, 0]
                ],
                [
                    [1, 0, -1],
                    [0, 0, 0],
                    [-1, 0, 1]
                ]
            ],
            [ // 卷积核4 - 模糊
                [
                    [0.1, 0.1, 0.1],
                    [0.1, 0.2, 0.1],
                    [0.1, 0.1, 0.1]
                ],
                [
                    [0.1, 0.15, 0.1],
                    [0.15, 0.2, 0.15],
                    [0.1, 0.15, 0.1]
                ],
                [
                    [0.1, 0.1, 0.1],
                    [0.1, 0.2, 0.1],
                    [0.1, 0.1, 0.1]
                ]
            ]
        ];
        
        // 偏置项 (每个卷积核一个)
        const biases = [0.1, -0.2, 0.3, -0.1];
        
        // 初始化变量
        const numKernels = 4;
        let currentStep = 0;
        let currentRow = 0;
        let currentCol = 0;
        let currentKernel = 0;
        let isAnimating = false;
        let animationInterval;
        
        // 特征图数据 (4个特征图，每个3x3)
        let featureMaps = Array(numKernels).fill().map(() => 
            Array(3).fill().map(() => Array(3).fill(0))
        );
        
        // 初始化网格
        function initializeGrids() {
            // 输入图像
            for (let c = 0; c < 3; c++) {
                const grid = document.getElementById(`input${c+1}`);
                grid.innerHTML = '';
                
                for (let i = 0; i < 5; i++) {
                    for (let j = 0; j < 5; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.textContent = inputData[c][i][j];
                        cell.id = `input-${c}-${i}-${j}`;
                        grid.appendChild(cell);
                    }
                }
            }
            
            // 卷积核
            const kernelsContainer = document.getElementById('kernelsContainer');
            kernelsContainer.innerHTML = '';
            
            for (let k = 0; k < numKernels; k++) {
                const kernelSet = document.createElement('div');
                kernelSet.className = 'kernel-set';
                
                const title = document.createElement('h4');
                title.textContent = `卷积核 ${k+1}`;
                kernelSet.appendChild(title);
                
                for (let c = 0; c < 3; c++) {
                    const channelLabel = document.createElement('div');
                    channelLabel.textContent = `通道 ${c+1}`;
                    kernelSet.appendChild(channelLabel);
                    
                    const grid = document.createElement('div');
                    grid.className = `grid kernel-channel${c+1}`;
                    grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
                    
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 3; j++) {
                            const cell = document.createElement('div');
                            cell.className = 'grid-cell';
                            cell.textContent = kernelsData[k][c][i][j];
                            cell.id = `kernel-${k}-${c}-${i}-${j}`;
                            grid.appendChild(cell);
                        }
                    }
                    
                    kernelSet.appendChild(grid);
                }
                
                kernelsContainer.appendChild(kernelSet);
            }
            
            // 特征图
            const featureMapsContainer = document.getElementById('featureMapsContainer');
            featureMapsContainer.innerHTML = '';
            
            for (let k = 0; k < numKernels; k++) {
                const featureMapItem = document.createElement('div');
                featureMapItem.className = 'feature-map-item';
                
                const title = document.createElement('h4');
                title.textContent = `特征图 ${k+1}`;
                featureMapItem.appendChild(title);
                
                const grid = document.createElement('div');
                grid.className = `grid feature-map feature-map-${k}`;
                grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
                grid.id = `feature-map-${k}`;
                
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.textContent = '0';
                        cell.id = `feature-${k}-${i}-${j}`;
                        grid.appendChild(cell);
                    }
                }
                
                featureMapItem.appendChild(grid);
                featureMapsContainer.appendChild(featureMapItem);
            }
        }
        
        // 执行卷积步骤
        function performConvolutionStep() {
            if (currentRow >= 3 || currentCol >= 3 || currentKernel >= numKernels) {
                stopAnimation();
                document.getElementById('stepIndicator').textContent = '所有卷积核计算完成！';
                return;
            }
            
            // 清除高亮
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('highlight');
            });
            
            // 高亮当前区域
            for (let c = 0; c < 3; c++) {
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        document.getElementById(`input-${c}-${currentRow+i}-${currentCol+j}`).classList.add('highlight');
                        document.getElementById(`kernel-${currentKernel}-${c}-${i}-${j}`).classList.add('highlight');
                    }
                }
                document.getElementById(`feature-${currentKernel}-${currentRow}-${currentCol}`).classList.add('highlight');
            }
            
            // 计算并显示结果
            let calculationText = `卷积核 ${currentKernel+1}，位置 [${currentRow}, ${currentCol}] 的计算：<br>`;
            let total = 0;
            
            for (let c = 0; c < 3; c++) {
                let channelSum = 0;
                calculationText += `<br>通道 ${c+1}: `;
                
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        const inputVal = inputData[c][currentRow+i][currentCol+j];
                        const kernelVal = kernelsData[currentKernel][c][i][j];
                        const product = inputVal * kernelVal;
                        channelSum += product;
                        
                        calculationText += `${inputVal}×${kernelVal}`;
                        if (i < 2 || j < 2) calculationText += " + ";
                    }
                }
                
                calculationText += ` = ${channelSum.toFixed(1)}`;
                total += channelSum;
            }
            
            // 加上偏置
            total += biases[currentKernel];
            calculationText += `<br><br>总和: ${total.toFixed(1)} + 偏置(${biases[currentKernel]}) = ${total.toFixed(1)}`;
            
            // 应用ReLU激活函数
            const activated = Math.max(0, total);
            calculationText += `<br>ReLU激活: max(0, ${total.toFixed(1)}) = ${activated.toFixed(1)}`;
            
            // 更新特征图
            featureMaps[currentKernel][currentRow][currentCol] = activated;
            document.getElementById(`feature-${currentKernel}-${currentRow}-${currentCol}`).textContent = activated.toFixed(1);
            
            // 更新计算显示
            document.getElementById('calculation').innerHTML = calculationText;
            document.getElementById('stepIndicator').textContent = 
                `正在计算卷积核 ${currentKernel+1} 的特征图位置 [${currentRow}, ${currentCol}]`;
            
            // 移动到下一个位置
            currentCol++;
            if (currentCol >= 3) {
                currentCol = 0;
                currentRow++;
                if (currentRow >= 3) {
                    currentRow = 0;
                    currentKernel++;
                }
            }
        }
        
        // 开始动画
        function startAnimation() {
            if (isAnimating) return;
            
            isAnimating = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
            
            animationInterval = setInterval(() => {
                performConvolutionStep();
            }, 1500);
        }
        
        // 停止动画
        function stopAnimation() {
            clearInterval(animationInterval);
            isAnimating = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('nextBtn').disabled = false;
        }
        
        // 下一步
        function nextStep() {
            if (isAnimating || currentKernel >= numKernels) return;
            performConvolutionStep();
        }
        
        // 重置
        function resetDemo() {
            stopAnimation();
            currentRow = 0;
            currentCol = 0;
            currentKernel = 0;
            
            // 重置特征图数据
            featureMaps = Array(numKernels).fill().map(() => 
                Array(3).fill().map(() => Array(3).fill(0))
            );
            
            initializeGrids();
            document.getElementById('stepIndicator').textContent = '准备演示多卷积核卷积过程...';
            document.getElementById('calculation').innerHTML = '点击"开始演示"查看详细计算过程...';
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initializeGrids();
            
            document.getElementById('startBtn').addEventListener('click', startAnimation);
            document.getElementById('resetBtn').addEventListener('click', resetDemo);
            document.getElementById('nextBtn').addEventListener('click', nextStep);
        });
    </script>
</body>
</html>
